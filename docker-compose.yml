services:
  vault:
    build:
      context: .
      dockerfile: vault/Dockerfile
    container_name: vault
    user: "1000:1000"
    environment:
      - VAULT_PASSWORD=${VAULT_PASSWORD:-change-me-in-production}
      - SERVICE_SECRET=${SERVICE_SECRET}
      - SERVICE_ID=vault
      - ALLOWED_CALLERS=gateway,rag-service,memory-service,heartbeat,codebot
      - WEB_CONCURRENCY=1
    volumes:
      - ./vault/secrets:/vault
    networks:
      - securebot
    restart: unless-stopped
    ports:
      - "8200:8200"
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://127.0.0.1:8200/health')"]
      interval: 30s
      timeout: 15s
      retries: 5
      start_period: 30s

  gateway:
    build:
      context: .
      dockerfile: gateway/Dockerfile
    container_name: gateway
    user: "1000:1000"
    environment:
      - VAULT_URL=http://vault:8200
      - OLLAMA_HOST=http://host.docker.internal:11434
      - RESPONSE_MODEL=${RESPONSE_MODEL:-llama3.2:3b-instruct-q4_K_M}
      - MEMORY_SERVICE_URL=http://memory-service:8300
      - RAG_URL=http://rag-service:8400
      - CODEBOT_URL=http://codebot:8500
      - SERVICE_SECRET=${SERVICE_SECRET}
      - SERVICE_ID=gateway
      - ALLOWED_CALLERS=external
      - GATEWAY_API_KEY=${GATEWAY_API_KEY}
      - WEB_CONCURRENCY=1
      - HF_HOME=/app/.cache/huggingface
      - SKILLS_DIR=/app/skills
      - MEMORY_DIR=/memory
    volumes:
      - ./skills:/app/skills
      - ./memory:/memory
      - ~/.cache/huggingface:/app/.cache/huggingface
      - /run/systemd/private:/run/systemd/private:ro
      - /var/run/dbus/system_bus_socket:/var/run/dbus/system_bus_socket:ro
    networks:
      - securebot
    ports:
      - "8080:8080"
    depends_on:
      - vault
      - memory-service
      - rag-service
      - codebot
    restart: unless-stopped
    extra_hosts:
      - "host.docker.internal:host-gateway"
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://127.0.0.1:8080/health')"]
      interval: 30s
      timeout: 15s
      retries: 5
      start_period: 30s

  codebot:
    build:
      context: .
      dockerfile: codebot/Dockerfile
    container_name: codebot
    environment:
      - GATEWAY_URL=http://gateway:8080
      - SERVICE_SECRET=${SERVICE_SECRET}
      - SERVICE_ID=codebot
      - ALLOWED_CALLERS=gateway
      - WEB_CONCURRENCY=1
      - HF_HOME=/workspace/.cache/huggingface
      - SKILLS_DIR=/workspace/skills
    volumes:
      - ./skills:/workspace/skills:rw
      - ~/.cache/huggingface:/workspace/.cache/huggingface
    networks:
      - securebot
    ports:
      - "8500:8500"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python3", "-c", "import urllib.request; urllib.request.urlopen('http://127.0.0.1:8500/health')"]
      interval: 30s
      timeout: 15s
      retries: 5
      start_period: 60s

  memory-service:
    build:
      context: .
      dockerfile: services/memory/Dockerfile
    container_name: memory-service
    user: "1000:1000"
    environment:
      - MEMORY_DIR=/memory
      - RAG_URL=http://rag-service:8400
      - SERVICE_SECRET=${SERVICE_SECRET}
      - SERVICE_ID=memory-service
      - ALLOWED_CALLERS=gateway,rag-service,heartbeat
      - WEB_CONCURRENCY=1
    volumes:
      - ./memory:/memory
    networks:
      - securebot
    ports:
      - "8300:8300"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://127.0.0.1:8300/health')"]
      interval: 30s
      timeout: 15s
      retries: 5
      start_period: 30s

  rag-service:
    build:
      context: .
      dockerfile: services/rag/Dockerfile
    container_name: rag-service
    user: "1000:1000"
    environment:
      - OLLAMA_HOST=http://host.docker.internal:11434
      - MEMORY_DIR=/memory
      - CHROMA_DIR=/chroma
      - SERVICE_SECRET=${SERVICE_SECRET}
      - SERVICE_ID=rag-service
      - ALLOWED_CALLERS=gateway,memory-service,heartbeat
      - WEB_CONCURRENCY=1
    volumes:
      - ./memory:/memory
      - ./chroma:/chroma
    networks:
      - securebot
    ports:
      - "8400:8400"
    restart: unless-stopped
    extra_hosts:
      - "host.docker.internal:host-gateway"
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://127.0.0.1:8400/health')"]
      interval: 30s
      timeout: 15s
      retries: 5
      start_period: 30s

networks:
  securebot:
    driver: bridge
