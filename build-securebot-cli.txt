Create a terminal TUI chat CLI at ~/securebot/securebot-cli.py

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
CRITICAL CURSES RULES - READ FIRST
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

These rules are non-negotiable. Violating any of them causes input
to break, CPU to spin at 100%, or terminal corruption:

1. NEVER call any curses function from a background thread.
   Background threads must ONLY set a threading.Event() flag.
   The main thread checks this flag and calls redraw() itself.

2. Input loop pattern - use EXACTLY this:
   self.stdscr.nodelay(True)   # non-blocking getch
   while self._running:
       time.sleep(0.02)        # REQUIRED - prevents 100% CPU spin
       ch = self.stdscr.getch()
       if ch == -1:
           # no key - handle redraws and continue
           if self._redraw_needed.is_set():
               self._redraw_needed.clear()
               self.redraw()
           elif time.time() - self._last_draw > 0.3:
               self.redraw()
               self._last_draw = time.time()
           continue
       self.handle_key(ch)
       self.redraw()

3. setup() must call ALL of these in this order:
   curses.cbreak()
   curses.noecho()
   self.stdscr.keypad(True)
   self.stdscr.nodelay(True)
   curses.curs_set(1)

4. NEVER call os.system('reset') anywhere. Ever.
   After /edit returns from nano, restore curses with:
   self.stdscr.keypad(True)
   curses.cbreak()
   curses.noecho()
   self.stdscr.clear()
   self.stdscr.refresh()

5. redraw() must ONLY be called from the main thread.
   Wrap all draw code in try/except that logs to
   /tmp/securebot-draw.log (never pass silently).

6. Background threads may ONLY do:
   - self._redraw_needed.set()
   - self.chat.add(...)  (if protected by threading.Lock)
   - HTTP requests
   - File I/O

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
LAYOUT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SecureBot CLI | llama3:8b | local | p2   tone:2|v:3 â”‚  â† blue bg
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ CPU  â–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘ 42%      â”‚ GPU  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘ 78%      â”‚
â”‚ RAM  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘ 61%      â”‚ VRAM â–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘ 41%      â”‚
â”‚ DISK /home 55%           â”‚ GPU Temp: 34Â°C           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ PID    CPU%  MEM%  PROCESS                          â”‚
â”‚ 14709  45.2   2.1  ollama                           â”‚
â”‚  1234  12.1   8.4  python3 gateway_service.py       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ¤– Bot: I have 3 pending tasks...                  â”‚
â”‚    [direct_ollama | 18.2s]                          â”‚
â”‚ You: What should I work on?                         â”‚
â”‚ ğŸ¤– Bot: Based on your tasks...                     â”‚
â”‚                                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ [tone:2|v:3] > _                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

- Header: row 0, blue background
- Resources: rows 1-3, split left/right at midpoint
- Separator: row 4
- Processes: rows 5-7 (header + 2 process rows)
- Separator: row 8
- Chat: rows 9 to h-3 (scrollable)
- Input: row h-2
- Status: row h-1 (startup messages, errors)

If terminal height < 20: skip process panel
If no GPU detected: expand CPU/RAM to full width

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
CONFIG (top of file)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

GATEWAY_URL    = "http://localhost:8080"
VAULT_URL      = "http://localhost:8200"
RAG_URL        = "http://localhost:8400"
USER_ID        = "roland"
MEMORY_DIR     = os.path.expanduser("~/securebot/memory")
VAULT_SECRETS  = os.path.expanduser("~/securebot/vault/secrets/secrets.json")
PREFS_FILE     = os.path.expanduser("~/.securebot-cli-prefs.json")
RESPONSE_MODEL = os.getenv("RESPONSE_MODEL", "llama3:8b")
REFRESH_INTERVAL      = 3      # seconds between resource updates
MAX_CHAT_LINES        = 100    # chat history buffer
SYSTEM_PROMPT_REFRESH = 30     # seconds between auto-rebuilds

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
SYSTEM PROMPT BUILDER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Build system prompt before every message sent to gateway.
Inject as "system" field in POST /message body.

STRUCTURE (use section delimiters - prevents model identity confusion):

"""
Answer only what is asked. Do not invent session IDs, timestamps,
privacy policies, or procedures not mentioned in the context.
Be direct and natural.

You are SecureBot, a personal AI assistant helping Roland with IT
automation, AI engineering, and system administration tasks.
Use the context below to give personalized, relevant answers.

--- IDENTITY ---
{full soul.md content}
--- END IDENTITY ---

--- USER PROFILE ---
{full user.md content}
--- END USER PROFILE ---

--- CURRENT SESSION ---
{full session.md content}
--- END SESSION ---

--- RELEVANT CONTEXT ---
{RAG context: GET /context?query={last_user_msg}&max_tokens=300}
--- END CONTEXT ---

--- AVAILABLE SKILLS ---
You have these automation skills. Use them when a request matches.
If no skill matches, say so clearly - do not pretend to execute
skills you do not have.
{all skills: - skill-name: description}
--- END SKILLS ---

--- TASKS ---
Active: {active_task.title} ({active_task.status})
Pending: {all todo titles with priority}
--- END TASKS ---

--- RESPONSE STYLE ---
{tone_instruction}
{verbosity_instruction}
--- END STYLE ---
"""

Rules:
- Read soul.md, user.md, session.md as actual files each time
- If RAG unreachable: skip RELEVANT CONTEXT section, log warning
- If file missing: skip that section with logging.warning()
- Rebuild on every message (not just every 30s)
- 30s background refresh updates skills/tasks only
- Temperature 0.7 in every gateway POST

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
TUNING SYSTEM
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Persist in PREFS_FILE, load on startup, create with defaults if missing.

TONE (1-3):
1 = Formal:   "Use formal, precise language. No contractions or colloquialisms."
2 = Balanced: "Be helpful and professional but approachable. Natural tone."
3 = Casual:   "Be friendly and conversational. Contractions fine, relaxed tone."

VERBOSITY (1-5):
1 = Curt:     "1-3 sentences maximum. Just the answer, no explanation."
2 = Brief:    "Answer directly with minimal elaboration. Skip preamble."
3 = Balanced: "Complete answers with necessary context. No padding."
4 = Detailed: "Thorough with examples and context. Anticipate follow-ups."
5 = Chatty:   "Comprehensive and conversational. Elaborate freely."

Show in prompt bar: [tone:2|v:3] >
Show in header bar: tone:2|v:3

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
RESOURCE MONITOR (background thread)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Runs every REFRESH_INTERVAL seconds. Sets _redraw_needed when done.
NEVER calls curses directly.

CPU: psutil.cpu_percent(interval=1)  â† blocking 1s sample, accurate
     Prime on startup: psutil.cpu_percent(interval=None) then sleep 0.5

RAM: psutil.virtual_memory().percent

DISK: psutil.disk_usage('/home').percent and psutil.disk_usage('/').percent
      Show: "DISK /home 55% / 32%"

GPU: subprocess nvidia-smi with timeout=3
     Query: utilization.gpu,memory.used,memory.total,temperature.gpu
     Format: csv,noheader,nounits
     Parse fields[0]=gpu%, fields[1]=vram_used, fields[2]=vram_total,
             fields[3]=temp
     VRAM%: (vram_used/vram_total)*100
     If nvidia-smi fails or not found: gpu_available=False, hide GPU panel

PROCESSES: psutil.process_iter(['pid','name','cpu_percent','memory_percent'])
           Sort by cpu_percent descending, show top 2
           Truncate process name to fit column width

Store all readings in a snapshot dict protected by threading.Lock()
Main thread calls monitor.snapshot() to get a copy for drawing.

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
RESOURCE BARS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Bar width = (panel_width - label_width - percent_width - 2)
Fill chars: â–ˆ for used, â–‘ for empty
Color: green < 80%, yellow 80-90%, red > 90%
GPU bars: cyan color always

Example: CPU  â–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘ 42%

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
CHAT PANEL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ChatBuffer class:
- Stores list of (text, color_attr) tuples, max MAX_CHAT_LINES
- Protected by threading.Lock()
- add(text, color) appends and trims to max
- get_lines() returns copy of list
- Word-wrap lines to panel width on draw

Scroll: PgUp/PgDn move scroll_offset, â†‘/â†“ move by 1
Pin to bottom on new message or Enter.

Message format:
  "You: {message}"          white
  "ğŸ¤– Bot: {response}"      cyan  
  "   [{method} | {time}s]" gray/dim
  "/command output"         varies by command
  "Error: {msg}"            red
  "[Claude Code] {line}"    yellow
  "[Haiku] {response}"      magenta

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
INPUT LINE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Manual line editor (no curses textpad):
- input_buf: string
- cursor_pos: int

Key bindings:
- Printable (32-126): insert at cursor_pos
- Backspace/127/8: delete left of cursor
- KEY_DC: delete right of cursor  
- KEY_LEFT/RIGHT: move cursor
- KEY_HOME/Ctrl-A (1): cursor to start
- KEY_END/Ctrl-E (5): cursor to end
- Ctrl-U (21): clear line
- Ctrl-K (11): kill to end
- KEY_UP: scroll chat up
- KEY_DOWN: scroll chat down
- KEY_PPAGE: scroll chat up 5
- KEY_NPAGE: scroll chat down 5
- Enter (10/13): submit
- Ctrl-C: exit

Show spinner while waiting for response: â ‹â ™â ¹â ¸â ¼â ´â ¦â §â ‡â 
Spinner replaces prompt prefix, not input content.

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
GATEWAY INTEGRATION
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

POST /message payload:
{
  "channel":     "cli",
  "user_id":     "roland",
  "text":        user_message,
  "system":      system_prompt,
  "temperature": 0.7
}

Fire in background thread (_worker):
1. Build system prompt (file reads + RAG call)
2. POST to gateway with 90s timeout
3. On success: chat.add(response, C_CYAN), chat.add(metadata, C_DIM)
4. On failure: chat.add("Error: ...", C_RED)
5. Always: self._thinking = False, self._redraw_needed.set()

Use urllib.request (stdlib only, no requests dependency).

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
SLASH COMMANDS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

All output goes to chat panel via chat.add().

MEMORY:
/memory          â†’ show soul.md + user.md in chat panel
/edit <soul|user|session>
                 â†’ curses.endwin(), subprocess.call([editor, path]),
                   then restore: keypad(True), cbreak(), noecho(),
                   clear(), refresh(), rebuild system prompt
/session <note>  â†’ append "## {timestamp}\n{note}" to session.md
/reload          â†’ reload all memory files, rebuild system prompt

TASKS:
/tasks           â†’ pretty print tasks.json (active + todo + completed)
/task <desc>     â†’ append to tasks.json todo array:
                   {id: task_{timestamp}, title: desc,
                    priority: medium, status: pending}
                   Confirm: "âœ… Task added: {desc}"

TUNING:
/tone <1-3>      â†’ set tone, save prefs, rebuild prompt, confirm
/verbosity <1-5> â†’ set verbosity, save prefs, rebuild prompt, confirm
/v <1-5>         â†’ shorthand verbosity
/t <1-3>         â†’ shorthand tone
/prefs           â†’ show current tone/verbosity with descriptions

SYSTEM:
/skills          â†’ GET /health, list all skills
/status          â†’ health check gateway/vault/rag/ollama, show âœ“/âœ—
/clear           â†’ clear chat panel only
/help            â†’ show all commands with descriptions
/quit /exit      â†’ self._running = False, clean exit

AI DELEGATION:
/cc <prompt>     â†’ subprocess.Popen(['claude', '-p',
                     '--dangerously-skip-permissions', prompt])
                   Stream stdout line by line to chat in yellow
                   Prefix: "[Claude Code] "
                   Run in daemon thread, non-blocking

/haiku <prompt>  â†’ GET anthropic_api_key from vault, fallback to
                   direct read from VAULT_SECRETS file
                   POST to https://api.anthropic.com/v1/messages
                   model="claude-haiku-4-5-20251001", max_tokens=1000
                   Show response in magenta, prefix "[Haiku] "
                   Run in daemon thread

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
COLORS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Use curses.init_pair(). Define constants at top of file:
C_HEADER   = 1   blue bg, white fg
C_USER     = 2   white
C_BOT      = 3   cyan
C_DIM      = 4   gray/dark
C_GREEN    = 5   green
C_YELLOW   = 6   yellow
C_RED      = 7   red
C_CYAN     = 8   cyan (GPU bars)
C_MAGENTA  = 9   magenta (Haiku)
C_BOLD     = 10  white bold

Use curses.use_default_colors() and init with -1 background.
Gray: find closest available color or use COLOR_BLACK | A_BOLD.

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ERROR HANDLING
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

- All draw errors: log to /tmp/securebot-draw.log with traceback
  NEVER pass silently - this hides bugs
- Gateway unreachable: red chat message, keep running
- Memory file missing: yellow warning in chat, continue
- RAG unreachable: yellow warning, fall back to full file injection
- nvidia-smi missing/fails: hide GPU panel, no crash
- Claude Code not installed: red message "Install: npm install -g @anthropic-ai/claude-code"
- Vault unreachable for Haiku: try direct file read, then red error
- psutil import fails: auto-install with pip then re-import
- NEVER let any exception propagate to curses.wrapper - always catch

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
STARTUP SEQUENCE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

1. _ensure_psutil() - install if missing
2. curses.wrapper(main)
3. setup() - init colors, cbreak, noecho, keypad, nodelay
4. monitor.start() - background resource thread
5. _startup() in daemon thread:
   a. chat.add("SecureBot CLI v1.0 â€” /help for commands", DIM)
   b. rag_warmup() - GET /context?query=hello&max_tokens=10
   c. chat.add("RAG ready.", GREEN) or warning
   d. sp_builder.build() - load memory files + skills
   e. chat.add("Ready.", DIM)
   f. self._redraw_needed.set()
6. Main input loop starts immediately (don't wait for startup thread)

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
TESTING REQUIREMENT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Before finishing, run these checks:

1. Syntax check:
   python3 -m py_compile ~/securebot/securebot-cli.py && echo "OK"

2. Import check:
   python3 -c "import ast; ast.parse(open('securebot-cli.py').read()); print('AST OK')"

3. Verify critical patterns exist:
   grep -c "time.sleep(0.02)" securebot-cli.py  # must be >= 1
   grep -c "nodelay(True)" securebot-cli.py      # must be >= 1
   grep -c "_redraw_needed.set()" securebot-cli.py  # must be >= 3
   grep -c "def redraw" securebot-cli.py         # must be 1

4. Verify NO violations:
   grep -n "os.system.*reset" securebot-cli.py   # must be empty
   grep -n "nodelay(False)" securebot-cli.py     # must be empty

Only output "DONE" when all checks pass.
chmod +x ~/securebot/securebot-cli.py
